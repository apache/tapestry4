<?xml version="1.0"?>
<!-- 
   Copyright 2004 The Apache Software Foundation

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->

<module id="tapestry.request" version="3.1.0">
  
  Services and configurations for the Tapestry request processing pipeline.
  It is expected that the IEngine interface will eventually "dissolve" into
  a collection of loosely bound services.
  
  <service-point id="EnginePool" interface="org.apache.tapestry.services.ObjectPool">
    <create-instance class="org.apache.tapestry.services.impl.ObjectPoolImpl"/>
  </service-point>  
  
  <service-point id="LocaleExtractor" interface="org.apache.tapestry.services.LocaleExtractor">
    
    Encapsulates the logic for extracting the locale for the current request.
    
    <invoke-factory>
      <construct class="org.apache.tapestry.services.impl.LocaleExtractorImpl">
        <set-service property="request" service-id="tapestry.globals.HttpServletRequest"/>
        <set-service property="cookieSource" service-id="CookieSource"/>
      </construct>
    </invoke-factory>
  </service-point>  
  
  <service-point id="CookieSource" interface="org.apache.tapestry.services.CookieSource">
    
    Allows access to incoming HTTP cookie values for the active (per-thread) request.
    
    <invoke-factory>
      <construct class="org.apache.tapestry.services.impl.CookieSourceImpl">
        <set-service property="request" service-id="tapestry.globals.HttpServletRequest"/>
      </construct>
    </invoke-factory>    
  </service-point>  
  
  <service-point id="EngineManager" interface="org.apache.tapestry.services.EngineManager">
    Obtains an IEngine implementation for the current request, either from a pool of
    such engine instance, from a factory, or from the HttpSession.
    
    <invoke-factory>
      <construct class="org.apache.tapestry.services.impl.EngineManagerImpl">
        <set-service property="enginePool" service-id="EnginePool"/>
        <set-service property="request" service-id="tapestry.globals.HttpServletRequest"/>
        <set-object property="servletName" value="service-property:tapestry.globals.ApplicationGlobals:servletName"/>
        <set-service property="engineFactory" service-id="EngineFactory"/>
        <set-service property="localeExtractor" service-id="LocaleExtractor"/>
      </construct>
    </invoke-factory>
  </service-point>  
  
  <service-point id="EngineFactory" interface="org.apache.tapestry.services.EngineFactory">
    
    Responsible for creating new instances of IEngine as needed.
    
    <invoke-factory>
      <construct class="org.apache.tapestry.services.impl.EngineFactoryImpl">
        <set-service property="applicationSpecification" service-id="tapestry.globals.ApplicationSpecification"/>
        <set-object property="defaultEngineClassName" value="global-property:org.apache.tapestry.engine-class"/>
      </construct>
    </invoke-factory>
    
  </service-point>  
  
  <service-point id="RequestServicerPipeline" interface="org.apache.tapestry.services.RequestServicer">
    
    A pipeline for handling each request.
    
    <invoke-factory service-id="hivemind.lib.PipelineFactory">
      <create-pipeline filter-interface="org.apache.tapestry.services.RequestServicerFilter"
        configuration-id="RequestServicerPipeline"/>
    </invoke-factory>    
  </service-point>
  
  <service-point id="InvokeEngineTerminator" interface="org.apache.tapestry.services.RequestServicer">
    
    Terminator service for the RequestServicerPipeline. This locates an IEngine instance that
    can take control of the request.
    
    <invoke-factory>
      <construct class="org.apache.tapestry.services.impl.InvokeEngineTerminator">
        <set-service property="engineManager" service-id="EngineManager"/>
        <set-object property="specification" value="service-property:tapestry.globals.ApplicationGlobals:specification"/>
        <set-object property="servlet" value="service-property:tapestry.globals.ApplicationGlobals:servlet"/>
        <set-service property="infrastructure" service-id="tapestry.Infrastructure"/>
      </construct>
    </invoke-factory>
  </service-point>    
  
  <configuration-point id="RequestServicerPipeline" schema-id="hivemind.lib.Pipeline">
    
    A pipeline for processing an incoming request.
    
  </configuration-point>
  
  <contribution configuration-id="RequestServicerPipeline">
    <terminator object="service:InvokeEngineTerminator"/>
  </contribution>  
</module>