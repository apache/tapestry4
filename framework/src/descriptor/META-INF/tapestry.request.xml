<?xml version="1.0"?>
<!-- 
   Copyright 2004, 2005 The Apache Software Foundation

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->

<module id="tapestry.request" version="3.1.0">
  
  Services and configurations for the Tapestry request processing pipeline.
  It is expected that the IEngine interface will eventually "dissolve" into
  a collection of loosely bound services.
  
  <service-point id="EnginePool" interface="org.apache.tapestry.services.ObjectPool">
    
    Contains engine instances, keyed on locale, ready for use in the current request.
    
    <invoke-factory>
      <construct class="org.apache.tapestry.services.impl.ObjectPoolImpl">
        <event-listener service-id="tapestry.ResetEventCoordinator"/>
      </construct>
    </invoke-factory> 
  </service-point>  
  
  <service-point id="RequestLocaleManager" interface="org.apache.tapestry.services.RequestLocaleManager">
    
    Encapsulates the logic for extracting the locale for the current request.
    
    <invoke-factory model="threaded">
      <construct class="org.apache.tapestry.services.impl.RequestLocaleManagerImpl">
        <set-service property="request" service-id="tapestry.globals.HttpServletRequest"/>
        <set-service property="cookieSource" service-id="CookieSource"/>
      </construct>
    </invoke-factory>
  </service-point>  
  
  <service-point id="CookieSource" interface="org.apache.tapestry.services.CookieSource">
    
    Allows access to incoming HTTP cookie values for the active (per-thread) request.
    
    <invoke-factory>
      <construct class="org.apache.tapestry.services.impl.CookieSourceImpl">
        <set-service property="request" service-id="tapestry.globals.HttpServletRequest"/>
        <set-service property="response" service-id="tapestry.globals.HttpServletResponse"/>
      </construct>
    </invoke-factory>    
  </service-point>  
  
  <service-point id="EngineManager" interface="org.apache.tapestry.services.EngineManager">
    Obtains an IEngine implementation for the current request, either from a pool of
    such engine instance, from a factory, or from the HttpSession.
    
    <invoke-factory>
      <construct class="org.apache.tapestry.services.impl.EngineManagerImpl">
        <set-service property="enginePool" service-id="EnginePool"/>
        <set-service property="request" service-id="tapestry.globals.HttpServletRequest"/>
        <set-object property="servletName" value="service-property:tapestry.globals.ApplicationGlobals:servletName"/>
        <set-service property="engineFactory" service-id="EngineFactory"/>
        <set-service property="localeManager" service-id="RequestLocaleManager"/>
      </construct>
    </invoke-factory>
  </service-point>  
  
  <service-point id="EngineFactory" interface="org.apache.tapestry.services.EngineFactory">
    
    Responsible for creating new instances of IEngine as needed.
    
    <invoke-factory>
      <construct class="org.apache.tapestry.services.impl.EngineFactoryImpl">
        <set-object property="applicationSpecification" value="infrastructure:applicationSpecification"/>
        <set-object property="defaultEngineClassName" value="global-property:org.apache.tapestry.engine-class"/>
      </construct>
    </invoke-factory>
    
  </service-point>  
  
  <service-point id="RequestServicerPipeline" interface="org.apache.tapestry.services.RequestServicer">
    
    A pipeline for handling each request.
    
    <invoke-factory service-id="hivemind.lib.PipelineFactory">
      <create-pipeline filter-interface="org.apache.tapestry.services.RequestServicerFilter"
        configuration-id="RequestServicerPipeline"/>
    </invoke-factory>    
  </service-point>
  
  <service-point id="InvokeEngineTerminator" interface="org.apache.tapestry.services.RequestServicer">
    
    Terminator service for the RequestServicerPipeline. This locates an IEngine instance that
    can take control of the request.
    
    <invoke-factory>
      <construct class="org.apache.tapestry.services.impl.InvokeEngineTerminator">
        <set-service property="engineManager" service-id="EngineManager"/>
        <set-object property="specification" value="service-property:tapestry.globals.ApplicationGlobals:specification"/>
        <set-object property="servlet" value="service-property:tapestry.globals.ApplicationGlobals:servlet"/>
        <set-service property="infrastructure" service-id="tapestry.Infrastructure"/>
      </construct>
    </invoke-factory>
  </service-point>    
  
  <configuration-point id="RequestServicerPipeline" schema-id="hivemind.lib.Pipeline">
    
    A pipeline for processing an incoming request.
    
  </configuration-point>
  
  <contribution configuration-id="RequestServicerPipeline">
    <terminator object="service:InvokeEngineTerminator"/>
  </contribution>  
  
  <service-point id="ResponseRenderer" interface="org.apache.tapestry.services.ResponseRenderer">
    Renders the active page as the response.
    
    <invoke-factory>
      <construct class="org.apache.tapestry.services.impl.ResponseRendererImpl">
        <set-service property="localeManager" service-id="RequestLocaleManager"/>
      </construct>
    </invoke-factory>
  </service-point>
  
  <service-point id="AbsoluteURLBuilder" interface="org.apache.tapestry.services.AbsoluteURLBuilder">
    
    Uses HttpServletRequest information to build complete URLs, suitable for use when
    sending client-side redirects.
    
    <invoke-factory>
      <construct class="org.apache.tapestry.services.impl.AbsoluteURLBuilderImpl">
        <set-service property="request" service-id="tapestry.globals.HttpServletRequest"/>
      </construct>
    </invoke-factory>
    
  </service-point>
  
  <service-point id="RequestCycleFactory" interface="org.apache.tapestry.services.RequestCycleFactory">
    
    Creates new IRequestCycle instances.
    
    <invoke-factory>
      <construct class="org.apache.tapestry.services.impl.RequestCycleFactoryImpl">
        <set-object property="encoders"
                    value="service-property:tapestry.url.LinkFactory:serviceEncoders"/>
        <set-service property="monitorFactory" service-id="tapestry.monitor.MonitorFactory"/>
        <set-object property="serviceMap" value="infrastructure:serviceMap"/> 
        <set-service property="strategySource" service-id="tapestry.persist.PropertyPersistenceStrategySource"/>       
      </construct>
    </invoke-factory>
    
  </service-point>  
</module>