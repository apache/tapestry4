<?xml version="1.0"?>
<!-- 
   Copyright 2004 The Apache Software Foundation

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->

<module id="tapestry" version="3.1.0">

  The master module for the Apache Tapestry web application framework.
  
  <sub-module descriptor="tapestry.init.xml"/>
  <sub-module descriptor="tapestry.globals.xml"/>
  <sub-module descriptor="tapestry.props.xml"/>
  <sub-module descriptor="tapestry.request.xml"/>
  <sub-module descriptor="tapestry.parse.xml"/>
  
  <service-point id="ClasspathResourceFactory" interface="org.apache.tapestry.services.ClasspathResourceFactory">
  
    Constructs new instances of ClasspathResource.
    
    <invoke-factory>
      <construct class="org.apache.tapestry.services.impl.ClasspathResourceFactoryImpl"/>
    </invoke-factory>
  </service-point>
   
  <service-point id="Infrastructure" interface="org.apache.tapestry.services.Infrastructure">
    
    A kind of "clearing house" of other services. The Infrastructure is provided to the
    IEngine instance via the InvokeEngineTerminator service (using an HttpServletRequest
    attribute).  The engine can then get the other services it depends upon.  Ultimately,
    Infrastructure may be removed and the entire IEngine interface may go away!
    
    <invoke-factory>
      <construct class="org.apache.tapestry.services.impl.InfrastructureImpl">
        <set-service property="applicationPropertySource" service-id="tapestry.props.ApplicationPropertySource"/>
        <set-service property="componentMessagesSource" service-id="ComponentMessagesSource"/>
        <set-service property="resetEventCoordinator" service-id="ResetEventCoordinator"/>
        <set-service property="templateSource" service-id="tapestry.parse.TemplateSource"/>
        <set-service property="specificationSource" service-id="tapestry.parse.SpecificationSource"/>
        <set-service property="objectPool" service-id="GlobalObjectPool"/>
      </construct>
    </invoke-factory>
    
  </service-point>
  
  <service-point id="ExtensionLookupFactory" interface="org.apache.hivemind.ServiceImplementationFactory">
    
    A service factory that, in fact, attempts to obtain service implementations
    as application extensions.  Failing that, a default implementation is
    constructed.
    
    <parameters-schema>
      
      <element name="lookup">
        
        <attribute name="extension-name" required="true"/>
        
        <conversion class="org.apache.tapestry.services.impl.ExtensionLookupParameter"/>
        
      </element>
      
    </parameters-schema>
    
    <invoke-factory>
      <construct class="org.apache.tapestry.services.impl.ExtensionLookupFactory">
        <set-service property="specification" service-id="tapestry.globals.ApplicationSpecification"/>
        <set-service property="defaultBuilder" service-id="hivemind.lib.DefaultImplementationBuilder"/>
      </construct>
    </invoke-factory>
  </service-point>
  
  
  <service-point id="ResetEventCoordinator" interface="org.apache.tapestry.services.ResetEventCoordinator">
    
    Coordinator for services that have cached information that should be cleared out (this happens
    constantly in development, much more rarely in production).
    
    <create-instance class="org.apache.tapestry.services.impl.ResetEventCoordinatorImpl"/>
  </service-point>
  
  <service-point id="GlobalObjectPool" interface="org.apache.tapestry.services.ObjectPool">
    
    A general purpose object pool used throughout the application. Care should be
    taken to ensure that keys are sufficiently unique.  This service will likely
    be removed soon; replaced with a number of more individual object pools
    (as necessary).
     
    <invoke-factory>
      <construct class="org.apache.tapestry.services.impl.ObjectPoolImpl">
        <event-listener service-id="ResetEventCoordinator"/>
      </construct>
    </invoke-factory> 
  </service-point> 
  
  
  <service-point id="ComponentMessagesSource" interface="org.apache.tapestry.services.ComponentMessagesSource">
    
    Used to provide components (including pages) with access to their own localized messages.
    
    <invoke-factory>
      <construct class="org.apache.tapestry.services.impl.ComponentMessagesSourceImpl">
        <event-listener service-id="ResetEventCoordinator"/>
        <set-object property="applicationPropertySource" value="infrastructure:applicationPropertySource"/>
      </construct>
    </invoke-factory>
    
  </service-point>
  
  <service-point id="InfrastructureObjectProvider" interface="org.apache.hivemind.service.ObjectProvider">
    
    ObjectProvider mapped to prefix "infrastructure:", the locator is the name of a property of the
    Infratructure service.
    
    <invoke-factory>
      <construct class="org.apache.tapestry.services.impl.InfrastructureObjectProvider">
        <set-service property="infrastructure" service-id="Infrastructure"/>
      </construct>
    </invoke-factory>
    
  </service-point>
  
  <contribution configuration-id="hivemind.ObjectProviders">
    <provider prefix="infrastructure" service-id="InfrastructureObjectProvider"/>
  </contribution>
  
  
  
</module>